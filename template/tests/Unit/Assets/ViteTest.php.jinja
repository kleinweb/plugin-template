<?php

declare(strict_types=1);


namespace Kleinweb\{{ prj_namespace }}\Tests\Unit\Assets;

use Kleinweb\{{ prj_namespace }}\Assets\Vite;
use Kleinweb\{{ prj_namespace }}\Tests\Unit\TestCase;
use RuntimeException;

final class ViteTest extends TestCase
{
    private string $tempDir;

    protected function setUp(): void
    {
        parent::setUp();
        $this->tempDir = sys_get_temp_dir() . '/vite-test-' . uniqid();
        mkdir($this->tempDir, 0777, true);
        mkdir($this->tempDir . '/.vite', 0777, true);
    }

    protected function tearDown(): void
    {
        $this->removeDirectory($this->tempDir);
        parent::tearDown();
    }

    public function testIsProductionReturnsTrueWhenScriptDebugNotDefined(): void
    {
        $vite = new Vite($this->tempDir, 'https://example.com/build');

        $this->assertTrue($vite->isProduction());
    }

    public function testIsDevServerRunningReturnsFalseWhenNoHotFile(): void
    {
        $vite = new Vite($this->tempDir, 'https://example.com/build');

        $this->assertFalse($vite->isDevServerRunning());
    }

    public function testIsDevServerRunningReturnsTrueWhenHotFileExists(): void
    {
        file_put_contents($this->tempDir . '/hot', 'http://localhost:5173');

        $vite = new Vite($this->tempDir, 'https://example.com/build');

        $this->assertTrue($vite->isDevServerRunning());
    }

    public function testManifestThrowsExceptionWhenNotFound(): void
    {
        $vite = new Vite($this->tempDir, 'https://example.com/build');

        $this->expectException(RuntimeException::class);
        $this->expectExceptionMessage('Vite manifest not found');

        $vite->manifest();
    }

    public function testManifestReturnsDecodedJson(): void
    {
        $manifest = [
            'resources/js/app.ts' => [
                'file' => 'assets/app-abc123.js',
                'css' => ['assets/app-abc123.css'],
            ],
        ];

        file_put_contents(
            $this->tempDir . '/.vite/manifest.json',
            json_encode($manifest)
        );

        $vite = new Vite($this->tempDir, 'https://example.com/build');

        $this->assertSame($manifest, $vite->manifest());
    }

    public function testAssetReturnsDevServerUrlInDevelopment(): void
    {
        file_put_contents($this->tempDir . '/hot', 'http://localhost:5173');

        // We need to make isProduction return false
        // Since SCRIPT_DEBUG is not defined, we can't test this directly
        // This test documents expected behavior
        $vite = new Vite($this->tempDir, 'https://example.com/build');

        // In production mode, it would look for manifest
        // This test would need SCRIPT_DEBUG to be defined
        $this->assertTrue(true); // Placeholder
    }

    public function testAssetReturnsManifestUrlInProduction(): void
    {
        $manifest = [
            'resources/js/app.ts' => [
                'file' => 'assets/app-abc123.js',
            ],
        ];

        file_put_contents(
            $this->tempDir . '/.vite/manifest.json',
            json_encode($manifest)
        );

        $vite = new Vite($this->tempDir, 'https://example.com/build');

        $url = $vite->asset('resources/js/app.ts');

        $this->assertSame('https://example.com/build/assets/app-abc123.js', $url);
    }

    public function testAssetThrowsExceptionForMissingEntry(): void
    {
        $manifest = [
            'resources/js/app.ts' => [
                'file' => 'assets/app-abc123.js',
            ],
        ];

        file_put_contents(
            $this->tempDir . '/.vite/manifest.json',
            json_encode($manifest)
        );

        $vite = new Vite($this->tempDir, 'https://example.com/build');

        $this->expectException(RuntimeException::class);
        $this->expectExceptionMessage('Vite manifest entry not found: resources/js/missing.ts');

        $vite->asset('resources/js/missing.ts');
    }

    public function testManifestIsCached(): void
    {
        $manifest = ['test' => ['file' => 'test.js']];

        file_put_contents(
            $this->tempDir . '/.vite/manifest.json',
            json_encode($manifest)
        );

        $vite = new Vite($this->tempDir, 'https://example.com/build');

        // First call
        $result1 = $vite->manifest();

        // Modify file (shouldn't affect cached result)
        file_put_contents(
            $this->tempDir . '/.vite/manifest.json',
            json_encode(['different' => ['file' => 'different.js']])
        );

        // Second call should return cached
        $result2 = $vite->manifest();

        $this->assertSame($result1, $result2);
    }

    private function removeDirectory(string $dir): void
    {
        if (!is_dir($dir)) {
            return;
        }

        $files = array_diff(scandir($dir), ['.', '..']);
        foreach ($files as $file) {
            $path = $dir . '/' . $file;
            is_dir($path) ? $this->removeDirectory($path) : unlink($path);
        }
        rmdir($dir);
    }
}
